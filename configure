#!/bin/sh
export PATH="$HOME/.cargo/bin:$PATH"

echo "Starting configuration of Rust build environment"

if test -f "src/rust/vendor.tar.gz"
then
    echo "Creation of src/rust/vendor.tar.gz skipped, because it exists already."
    echo "To force an update, remove src/rust/vendor and src/rust/vendor.tar.gz manually."
    # This is the expected case in bundled packages (as submitted to CRAN).
    # In raw source packages however (e.g. after a fresh git clone), src/rust/vendor.tar.gz
    # does not exist yet and we need to create it (in the else branch).
else
    echo "Starting creation of src/rust/vendor.tar.gz"
    if test -d "src/rust/vendor"
    then
        echo "Calling (cd src/rust && cargo vendor) skipped, because src/rust/vendor exists already."
        echo "To force an update, remove src/rust/vendor and src/rust/vendor.tar.gz manually."
    else
        echo "Calling (cd src/rust && cargo vendor)"
        (cd src/rust && cargo vendor)
    fi
    echo "Calling (cd src/rust && tar -cJf vendor.tar.xz vendor)"
    (cd src/rust && tar -cJf vendor.tar.xz vendor)
fi

echo "Finished configuration of Rust build environment"
